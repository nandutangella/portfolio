<!DOCTYPE html>
<html>
<head>
	<title>Function Diagnostic</title>
	<style>
		body { font-family: monospace; padding: 20px; }
		pre { background: #f5f5f5; padding: 10px; border-radius: 4px; }
		.error { color: red; }
		.success { color: green; }
	</style>
</head>
<body>
	<h1>Cloudflare Pages Function Diagnostic</h1>
	<button onclick="runDiagnostics()">Run Diagnostics</button>
	<div id="results"></div>

	<script>
		async function runDiagnostics() {
			const results = document.getElementById('results');
			results.innerHTML = '<p>Running diagnostics...</p>';
			
			const tests = [];
			
			// Test 1: Check if function exists
			tests.push({
				name: 'Test 1: Check /api/chat endpoint',
				test: async () => {
					const response = await fetch('/api/chat', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ test: true })
					});
					
					const text = await response.text();
					const isHTML = text.trim().startsWith('<');
					
					return {
						status: response.status,
						isHTML: isHTML,
						contentType: response.headers.get('content-type'),
						preview: text.substring(0, 200),
						success: !isHTML && response.status !== 404
					};
				}
			});
			
			// Test 2: Check OPTIONS
			tests.push({
				name: 'Test 2: Check OPTIONS preflight',
				test: async () => {
					const response = await fetch('/api/chat', { method: 'OPTIONS' });
					return {
						status: response.status,
						success: response.status === 204 || response.status === 200
					};
				}
			});
			
			// Run all tests
			let html = '<h2>Results:</h2>';
			for (const test of tests) {
				try {
					const result = await test.test();
					const statusClass = result.success ? 'success' : 'error';
					html += `<div class="${statusClass}">`;
					html += `<h3>${test.name}</h3>`;
					html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
					html += `</div>`;
				} catch (error) {
					html += `<div class="error">`;
					html += `<h3>${test.name}</h3>`;
					html += `<pre>Error: ${error.message}</pre>`;
					html += `</div>`;
				}
			}
			
			html += '<h3>Diagnosis:</h3>';
			html += '<ul>';
			html += '<li>If you see HTML content, the function is NOT deployed</li>';
			html += '<li>If you see 404, the function route is wrong</li>';
			html += '<li>If you see 405, the function IS running but method is wrong</li>';
			html += '<li>If you see JSON error, the function IS running!</li>';
			html += '</ul>';
			
			results.innerHTML = html;
		}
	</script>
</body>
</html>
